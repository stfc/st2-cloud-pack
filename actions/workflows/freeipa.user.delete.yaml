version: 1.0
description: Deletes users on the FreeIPA server

input:
  - server_env
  - user_base_name
  - first_index
  - last_index

vars:
  - usernames: null
  - stdout: null

tasks:
  generate_users:
    action: stackstorm_openstack.freeipa.generate.usernames
      user_base_name=<% ctx(user_base_name) %>
      user_start_index=<% ctx(first_index) %>
      user_end_index=<% ctx(last_index) %>
    next:
        - when: <% succeeded() %>
          publish:
            - usernames: <% result().result %>
          do:
            - delete_users
            - print_usernames

  delete_users:
    with: username in <% ctx(usernames) %>
    action: freeipa.user_del
      uid=<% item(username) %>
      continue=False
      connection=<% ctx().server_env %>

  print_usernames:
    with: username in <% ctx(usernames) %>
    action: core.echo
      message="<% item(username) %>"
    next:
      - publish: stdout=<% result().stdout %>

output:
  - stdout: <% ctx(stdout) %>
