version: 1.0
description: Deletes users on the FreeIPA server and the associated JupyterHub account

input:
  - server_env
  - jupyter_env
  - user_base_name
  - first_index
  - last_index

vars:
  - usernames: null
  - stdout: null

tasks:
  generate_usernames:
    action: stackstorm_openstack.freeipa.generate.usernames
      user_base_name=<% ctx(user_base_name) %>
      user_start_index=<% ctx(first_index) %>
      user_end_index=<% ctx(last_index) %>
    next:
        - when: <% succeeded() %>
          publish:
            - usernames: <% result().result %>
          do:
            - delete_freeipa_users
            - print_usernames

  delete_freeipa_users:
    with: username in <% ctx(usernames) %>
    action: freeipa.user_del
      uid=<% item(username) %>
      connection=<% ctx().server_env %>
      continue=False
    next:
      - when: <% succeeded() %>
        do:
          - stop_jupyter_servers

  stop_jupyter_servers:
    action: stackstorm_openstack.jupyter.server.stop
      user=<% ctx(user_base_name) %>
      first_index=<% ctx(first_index) %>
      last_index=<% ctx(last_index) %>
      jupyter_env=<% ctx(jupyter_env) %>
    next:
      - when: <% succeeded() %>
        do:
          - delete_jupyter_users

  delete_jupyter_users:
    action: stackstorm_openstack.jupyter.user.delete
      user=<% ctx(user_base_name) %>
      first_index=<% ctx(first_index) %>
      last_index=<% ctx(last_index) %>
      jupyter_env=<% ctx(jupyter_env) %>

  print_usernames:
    with: username in <% ctx(usernames) %>
    action: core.echo
      message="<% item(username) %>"
    next:
      - publish: stdout=<% result().stdout %>

output:
  - stdout: <% ctx(stdout) %>
